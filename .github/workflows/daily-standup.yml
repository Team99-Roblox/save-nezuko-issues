name: Daily Standup Summary

on:
  schedule:
    # 每天早上9点（UTC+8，即 UTC 1:00）运行
    - cron: '0 1 * * 1-5'
  workflow_dispatch:

env:
  TARGET_REPO: Team99-Roblox/save-nezuko

jobs:
  daily-standup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code for Daily Standup
        uses: white-dragon-tools/claude-code-action@main
        with:
          target_repository: ${{ env.TARGET_REPO }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.SAVE_NEZUKO_CLAUDE_CROSS_REPO }}
          base_branch: dev
          claude_args: |
            --allowedTools "Bash(gh issue list:*),Bash(gh issue view:*),Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh issue create:*)"

          prompt: |
            **使用中文交流**

            你是一个每日晨报和站会概要生成助手。你的任务是收集昨日（北京时间）的项目活动并生成一份简洁的站会报告。

            REPO: ${{ github.repository }}
            TARGET_REPO: Team99-Roblox/save-nezuko

            任务步骤：

            1. 确定统计时间范围（北京时间 UTC+8）：
              - 统计范围：昨日 00:00 至 今日 00:00（北京时间），即完整的一个自然天
              - 换算为 UTC：前日 16:00 至 昨日 16:00
              - 例如：如果今天是 2026-01-30，则统计 2026-01-28T16:00:00Z 至 2026-01-29T16:00:00Z 的数据（即北京时间 2026-01-29 全天）

            2. 收集活动数据：
              - 使用 `gh issue list --repo Team99-Roblox/save-nezuko --state all --limit 100 --json number,title,state,createdAt,closedAt,labels` 获取 issues
              - 使用 `gh pr list --repo Team99-Roblox/save-nezuko --state all --limit 100 --json number,title,state,createdAt,closedAt,mergedAt` 获取 PRs
              - 筛选出在统计时间范围内创建、关闭或合并的内容

            3. 分析并整理以下信息：
              - 昨日完成：在统计时间范围内关闭的 issues 和合并的 PRs
              - 进行中：当前打开的 issues 和 PRs
              - 新增：在统计时间范围内新创建的 issues
              - 阻塞项：标记为 blocked 或高优先级但未处理的 issues
              - 超期未完成：创建时间超过 2 天且仍处于 open 状态的 issues（按创建时间从早到晚排序）

            4. 生成站会报告，格式如下：
              ```
              # 每日站会概要 - [日期]
              
              > 统计时间范围：[昨日日期] 00:00 - 24:00（北京时间）

              ## 昨日完成
              - [列出已完成的工作]

              ## 今日计划
              - [列出进行中和待处理的高优先级工作]

              ## 阻塞项/风险
              - [列出任何阻塞或风险项]

              ## 超期未完成（>2天）
              - [列出创建超过2天仍未关闭的 issues，格式：#issue号 标题 (已创建X天)]

              ## 统计
              - 新增 Issues: X
              - 关闭 Issues: X
              - 合并 PRs: X
              - 超期未完成 Issues: X
              ```

            5. 在 ${{ github.repository }} 仓库创建一个新的 issue 发布报告：
              - 使用 `gh issue create --repo ${{ github.repository }} --title "每日站会概要 - $(TZ=Asia/Shanghai date +%Y-%m-%d)" --body "报告内容" --label "standup"`

            注意事项：
            - 报告要简洁明了，便于快速阅读
            - 重点突出重要的进展和阻塞项
            - 如果没有相关活动，在对应部分注明"无"
            - 所有时间显示均使用北京时间
