name: Reproduce (Manual)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to reproduce'
        required: true
        type: number

env:
  TARGET_REPO: Team99-Roblox/save-nezuko
  NODE_AUTH_TOKEN: ${{ secrets.BEVY_PACKAGES_TOKEN }}

jobs:
  claude:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
      packages: read
    steps:
      - name: Fix git config for HTTPS
        shell: powershell
        run: |
          git config --global --unset-all url.git@github.com:.insteadOf 2>$null
          git config --global --add safe.directory '*'
          exit 0

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.SAVE_NEZUKO_CLAUDE_CROSS_REPO }}
          ref: dev
          fetch-depth: 0
          clean: false
          path: save-nezuko

      - name: Reset git state
        working-directory: save-nezuko
        run: |
          git reset --hard origin/dev
          git clean -fd -e node_modules -e .pnpm-store
        continue-on-error: true

      - name: Configure git for private repos
        run: git config --global url."https://x-access-token:${{ secrets.SAVE_NEZUKO_CLAUDE_CROSS_REPO }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js with GitHub Packages auth
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          package_json_file: save-nezuko/package.json

      - name: Set pnpm store to user directory
        run: pnpm config set store-dir $env:USERPROFILE\.pnpm-store

      - name: Install dependencies
        working-directory: save-nezuko
        run: pnpm install

      - name: Setup Rokit (Windows)
        shell: powershell
        run: |
          if (-not (Get-Command rokit -ErrorAction SilentlyContinue)) {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/rojo-rbx/rokit/releases/latest"
            $asset = $release.assets | Where-Object { $_.name -like "*windows-x86_64.zip" } | Select-Object -First 1
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "$env:TEMP\rokit.zip"
            Expand-Archive -Path "$env:TEMP\rokit.zip" -DestinationPath "$env:USERPROFILE\.rokit\bin" -Force
            $env:PATH = "$env:USERPROFILE\.rokit\bin;$env:PATH"
          }
          rokit --version

      - name: Run Droid
        working-directory: save-nezuko
        shell: powershell
        run: |
          $taskName = "DroidTask"
          $action = New-ScheduledTaskAction -Execute "C:\Users\User\bin\droid.exe" -Argument '"请进行集成测试"' -WorkingDirectory "$PWD"
          $trigger = New-ScheduledTaskTrigger -Once -At (Get-Date).AddSeconds(5)
          $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries
          $principal = New-ScheduledTaskPrincipal -UserId "User" -LogonType Interactive -RunLevel Highest
          
          Unregister-ScheduledTask -TaskName $taskName -Confirm:$false -ErrorAction SilentlyContinue
          Register-ScheduledTask -TaskName $taskName -Action $action -Trigger $trigger -Settings $settings -Principal $principal
          
          Start-Sleep -Seconds 10
          Start-ScheduledTask -TaskName $taskName
          
          # 等待任务完成
          $timeout = 600
          $elapsed = 0
          while ($elapsed -lt $timeout) {
            $task = Get-ScheduledTask -TaskName $taskName
            if ($task.State -eq "Ready") { break }
            Start-Sleep -Seconds 10
            $elapsed += 10
            Write-Host "Waiting... ($elapsed s)"
          }
          
          $result = Get-ScheduledTaskInfo -TaskName $taskName
          Write-Host "Task completed with result: $($result.LastTaskResult)"
          Unregister-ScheduledTask -TaskName $taskName -Confirm:$false
