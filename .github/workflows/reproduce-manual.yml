name: Reproduce (Manual)

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to reproduce'
        required: true
        type: number

env:
  TARGET_REPO: Team99-Roblox/save-nezuko
  NODE_AUTH_TOKEN: ${{ secrets.BEVY_PACKAGES_TOKEN }}

jobs:
  claude:
    runs-on: self-hosted
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
      packages: read
    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.SAVE_NEZUKO_CLAUDE_CROSS_REPO }}
          ref: dev
          fetch-depth: 0
          clean: false
          path: save-nezuko

      - name: Reset git state
        working-directory: save-nezuko
        run: |
          git reset --hard origin/dev
          git clean -fd -e node_modules -e .pnpm-store
        continue-on-error: true

      - name: Configure git for private repos
        run: git config --global url."https://x-access-token:${{ secrets.SAVE_NEZUKO_CLAUDE_CROSS_REPO }}@github.com/".insteadOf "https://github.com/"

      - name: Setup Node.js with GitHub Packages auth
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: 'https://npm.pkg.github.com'

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          package_json_file: save-nezuko/package.json

      - name: Set pnpm store to user directory
        run: pnpm config set store-dir $env:USERPROFILE\.pnpm-store

      - name: Install dependencies
        working-directory: save-nezuko
        run: pnpm install

      - name: Setup Rokit (Windows)
        shell: powershell
        run: |
          if (-not (Get-Command rokit -ErrorAction SilentlyContinue)) {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/rojo-rbx/rokit/releases/latest"
            $asset = $release.assets | Where-Object { $_.name -like "*windows-x86_64.zip" } | Select-Object -First 1
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "$env:TEMP\rokit.zip"
            Expand-Archive -Path "$env:TEMP\rokit.zip" -DestinationPath "$env:USERPROFILE\.rokit\bin" -Force
            $env:PATH = "$env:USERPROFILE\.rokit\bin;$env:PATH"
          }
          rokit --version

      - name: Run Claude Code
        working-directory: save-nezuko
        run: d:\software\cc.bat hi
